// @ts-nocheck
import { join, fromFileUrl, dirname } from "https://deno.land/std@0.224.0/path/mod.ts";

const __dirname = dirname(fromFileUrl(import.meta.url));
const API_DIR = join(__dirname, 'api');
// 1. ä¿®æ”¹è¾“å‡ºæ–‡ä»¶å
const OUTPUT_FILE = join(__dirname, 'deno-deploy-entry.ts');

interface RouteInfo {
	path: string;
	modulePath: string;
	importName: string;
}

async function generateAdapter() {
	console.log("ğŸ” Scanning for functions in:", API_DIR);
	const routes: RouteInfo[] = [];

		for await (const entry of Deno.readDir(API_DIR)) {
		if (entry.isDirectory || !/\.(ts|js)$/.test(entry.name)) {
			console.log(`- Skipping ${entry.name}`);
			continue;
		}

		const fileName = entry.name;
		const routePath = `/api/${fileName.replace(/\.(ts|js)$/, '')}`;
		const modulePath = `./api/${fileName}`;
		const importName = `handler_${fileName.replace(/[^a-zA-Z0-9]/g, '_')}`;

		routes.push({
			path: routePath,
			modulePath,
			importName,
		});
		console.log(`âœ… Found API route: ${routePath} -> ${modulePath}`);

		// å°†æ–‡ä»¶ä¸­çš„ import .js æ›¿æ¢ä¸º import .ts
		const filePath = join(API_DIR, fileName);
		let content = await Deno.readTextFile(filePath);
		const updatedContent = content.replace(/(import\s+.*?from\s+['"].*?)\.js(['"])/g, '$1.ts$2');
		if (content !== updatedContent) {
			await Deno.writeTextFile(filePath, updatedContent);
			console.log(`   ğŸ”„ Updated imports in ${fileName} from .js to .ts`);
		}
	}

	// --- ç”Ÿæˆä»£ç  ---
	const imports = routes.map(r =>
			`import ${r.importName} from '${r.modulePath}';`
	).join('\n');

	const apiCases = routes.map(r => `
        case '${r.path}':
            return ${r.importName}(req);`).join('');

	const fileContent = `
// @ts-nocheck
// -----------------------------------------------------------------------------
// âš ï¸ THIS FILE IS AUTO-GENERATED BY build.ts. DO NOT EDIT MANUALLY.
// -----------------------------------------------------------------------------

import { serveDir } from "https://deno.land/std@0.224.0/http/file_server.ts";
${imports}

console.log("ğŸš€ Deno Deploy server starting with generated routes...");

// --- Deno Deploy Server Entry ---
Deno.serve(async (req: Request) => {
    const url = new URL(req.url);
    const pathname = url.pathname;

    // --- Router ---
    switch (pathname) {
        // Dynamic API routes
        ${apiCases}

				// Static routes
        default:
            return serveDir(req, {
							fsRoot: "public", // æŒ‡å®šé™æ€æ–‡ä»¶çš„æ ¹ç›®å½•
							urlRoot: "", // URL çš„æ ¹è·¯å¾„
						});
    }
});
`;

	await Deno.writeTextFile(OUTPUT_FILE, fileContent.trim());
	console.log(`\nğŸ‰ Successfully generated adapter file: ${OUTPUT_FILE}`);
	console.log("You can now run 'deno run --allow-net --allow-read deno-deploy-entry.ts' to test it.");
}

generateAdapter();
